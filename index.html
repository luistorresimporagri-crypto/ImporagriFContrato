<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dropdown desde Google Sheets (Columna A)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;padding:24px;background:#f7f9fc;color:#0e1b2a}
    label{display:block;margin-bottom:8px;font-weight:700}
    select{width:100%;max-width:560px;height:44px;border:1px solid #d5e0ea;border-radius:10px;padding:0 12px;background:#fff}
    .muted{color:#6b7a8c;font-size:14px;margin-top:8px}
    .err{color:#b00020;margin-top:10px}
  </style>
</head>
<body>
  <label for="razonSocial">Nombre / Razón Social</label>
  <select id="razonSocial" disabled>
    <option>Cargando opciones…</option>
  </select>
  <div id="info" class="muted">Fuente: Columna A de Google Sheets publicado.</div>
  <div id="error" class="err" hidden></div>

  <script>
  (async () => {
    // 1) CONFIGURA TU URL (CSV)
    // Sustituye la de ejemplo con la tuya en formato CSV:
    // https://docs.google.com/spreadsheets/d/e/.../pub?gid=XXXX&single=true&output=csv
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwKa8Ror8z-Ogwn6ejP72NCcylbuIFZH_9pb3QygPiRN3VWIeWKGy0j3pxohuXSURgUSB-drFqrENM/pub?gid=1640588024&single=true&output=csv";

    // 2) URL fallback (gviz JSON)
    const GVIZ_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwKa8Ror8z-Ogwn6ejP72NCcylbuIFZH_9pb3QygPiRN3VWIeWKGy0j3pxohuXSURgUSB-drFqrENM/gviz/tq?gid=1640588024&tqx=out:json";

    const $select = document.getElementById('razonSocial');
    const $err = document.getElementById('error');

    // Utilidad: limpia, deduplica y ordena
    const normalizeList = (arr, hasHeaderGuess) => {
      let list = arr.map(s => String(s ?? '').trim()).filter(s => s.length > 0);
      // Si la primera celda luce como encabezado, la omitimos
      if (list.length && hasHeaderGuess(list[0])) list = list.slice(1);
      // Dedup + orden
      list = Array.from(new Set(list)).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
      return list;
    };

    const looksLikeHeader = (s) => {
      const low = s.toLowerCase();
      // heurística para detectar encabezados típicos
      return /nombre|raz[oó]n/.test(low);
    };

    const fillSelect = (options) => {
      $select.innerHTML = '<option value="" selected disabled>Selecciona…</option>';
      for (const name of options) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        $select.appendChild(opt);
      }
      $select.disabled = options.length === 0;
      if (!options.length) {
        $select.innerHTML = '<option value="" selected disabled>(Sin datos en columna A)</option>';
      }
    };

    const parseCSVFirstColumn = (csvText) => {
      // Parser CSV simple (maneja comillas básicas)
      const rows = [];
      let cur = '', inQuotes = false, row = [];
      const pushCell = () => { row.push(cur); cur = ''; };
      const pushRow = () => { rows.push(row); row = []; };
      for (let i=0; i<csvText.length; i++){
        const c = csvText[i], n = csvText[i+1];
        if (c === '"' ) {
          if (inQuotes && n === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (c === ',' && !inQuotes) {
          pushCell();
        } else if ((c === '\n' || c === '\r') && !inQuotes) {
          // soporta \r\n, \n, \r
          pushCell(); pushRow();
          if (c === '\r' && n === '\n') i++;
        } else {
          cur += c;
        }
      }
      // último campo/fila si quedó pendiente
      if (cur.length || row.length) { pushCell(); pushRow(); }

      // Tomamos solo la primera columna (A)
      return rows.map(r => r[0] ?? '');
    };

    const fetchCSV = async () => {
      const res = await fetch(SHEET_CSV_URL, { mode: 'cors', cache: 'no-store' });
      if (!res.ok) throw new Error(`Error HTTP CSV: ${res.status}`);
      const text = await res.text();
      return parseCSVFirstColumn(text);
    };

    const fetchGViz = async () => {
      const res = await fetch(GVIZ_URL, { mode: 'cors', cache: 'no-store' });
      if (!res.ok) throw new Error(`Error HTTP GVIZ: ${res.status}`);
      const text = await res.text();
      // GViz devuelve: google.visualization.Query.setResponse({...});
      const jsonStr = text.replace(/^[\s\S]*setResponse\(/,'').replace(/\)\s*;?\s*$/,'');
      const data = JSON.parse(jsonStr);
      const cols = data.table?.cols ?? [];
      const rows = data.table?.rows ?? [];
      // Columna A = índice 0
      const col0 = rows.map(r => {
        const c0 = r.c?.[0];
        return (c0 && c0.v != null) ? String(c0.v) : '';
      });
      return col0;
    };

    try {
      let colA = await fetchCSV();
      let list = normalizeList(colA, looksLikeHeader);
      if (!list.length) {
        // fallback a gviz si CSV no trajo nada útil
        colA = await fetchGViz();
        list = normalizeList(colA, looksLikeHeader);
      }
      fillSelect(list);
    } catch (e) {
      console.error(e);
      // Último intento: gviz
      try {
        const colA = await fetchGViz();
        const list = normalizeList(colA, looksLikeHeader);
        fillSelect(list);
      } catch (e2) {
        console.error(e2);
        $err.hidden = false;
        $err.textContent = 'No se pudo cargar la columna A desde Google Sheets. Verifica que el documento esté publicado y accesible públicamente.';
        $select.innerHTML = '<option value="" selected disabled>Error al cargar</option>';
        $select.disabled = true;
      }
    }

    // (Opcional) Manejar el cambio
    $select.addEventListener('change', () => {
      console.log('Seleccionado:', $select.value);
    });
  })();
  </script>
</body>
</html>
